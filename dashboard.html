<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stranger Call – Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --muted: #9ca3af;
      --line: #2d3748;
      --brand: #22c55e;
    }
    body {
      background: var(--bg);
      color: #e6edf3;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
    }
    .btn {
      transition: .2s ease;
      font-weight: 600;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-primary {
      background: var(--brand);
      color: #000;
    }
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
    }
    .pill {
      border: 1px solid var(--line);
      background: #0f1520;
    }
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    .video-wrap video {
      border-radius: 12px;
      border: 1px solid #273244;
    }
    .backdrop {
      background: rgba(0, 0, 0, 0.6);
    }
    .loader {
      border: 3px solid #1f2937;
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* Sidebar styles */
    .sidebar {
      width: 280px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .sidebar.open {
      transform: translateX(0);
    }
    @media (min-width: 1024px) {
      .sidebar {
        transform: translateX(0);
        position: static;
        height: auto;
      }
      .main-content {
        margin-left: 280px;
        width: calc(100% - 280px);
      }
    }
    /* Full screen call modal */
    .call-modal-fullscreen {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: var(--bg);
    }
    .call-controls {
      position: absolute;
      bottom: 2rem;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .control-btn.active {
      background: rgba(255, 255, 255, 0.2);
    }
    .control-btn.end-call {
      background: #ef4444;
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .remote-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .local-video {
      position: absolute;
      bottom: 120px;
      right: 20px;
      width: 180px;
      height: 120px;
      border-radius: 8px;
      border: 2px solid white;
      object-fit: cover;
      z-index: 10;
    }
  </style>
</head>
<body class="min-h-screen scroll-smooth flex">
  <!-- Sidebar -->
  <div class="sidebar fixed top-0 left-0 h-full z-50 bg-[#0d1117] border-r border-[#2d3748] lg:relative lg:z-auto overflow-y-auto">
    <div class="p-4 flex items-center gap-2 border-b border-[#2d3748]">
      <div class="w-8 h-8 rounded-lg bg-emerald-400/10 grid place-items-center border border-emerald-500/40">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A2 2 0 0122 9.528v4.944a2 2 0 01-2.447 1.804L15 14M4 6h8m-8 6h8m-8 6h8"/>
        </svg>
      </div>
      <h1 class="text-lg font-semibold">Stranger Call</h1>
      <button id="closeSidebar" class="ml-auto lg:hidden">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- User profile in sidebar -->
    <div id="authUser" class="p-4 border-b border-[#2d3748] flex items-center gap-3">
      <img id="meAvatar" class="w-10 h-10 rounded-full object-cover border border-[#2d3748]" src="https://www.svgrepo.com/show/452030/avatar-default.svg" alt="me"/>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span id="meName" class="text-sm font-medium truncate"></span>
          <span id="meOnlineDot" class="online-dot bg-gray-500"></span>
        </div>
        <div class="text-xs text-gray-400 truncate" id="meEmail"></div>
      </div>
    </div>

    <!-- Filters in sidebar -->
    <div class="p-4">
      <h2 class="text-sm font-semibold text-gray-400 mb-3">FILTERS</h2>
      
      <div class="mb-4">
        <label class="block text-sm text-gray-400 mb-1">Gender</label>
        <select id="genderFilter" class="w-full bg-[#0f1520] border border-[#2d3748] rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="">All genders</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block text-sm text-gray-400 mb-1">Status</label>
        <select id="presenceFilter" class="w-full bg-[#0f1520] border border-[#2d3748] rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="">Any status</option>
          <option value="online">Online</option>
          <option value="offline">Offline</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block text-sm text-gray-400 mb-1">Age Range</label>
        <div class="flex items-center gap-2">
          <input id="minAge" type="number" min="13" max="120" value="13" class="w-16 bg-[#0f1520] border border-[#2d3748] rounded-xl px-3 py-2 outline-none"/>
          <span class="text-gray-500">to</span>
          <input id="maxAge" type="number" min="13" max="120" value="120" class="w-16 bg-[#0f1520] border border-[#2d3748] rounded-xl px-3 py-2 outline-none"/>
        </div>
      </div>

      <button id="resetFilters" class="w-full btn pill px-3 py-3 rounded-xl mb-6">Reset Filters</button>
      
      <button id="signOutBtn" class="w-full btn px-3 py-3 rounded-xl bg-red-500/10 text-red-500 border border-red-500/20">
        <i class="fas fa-sign-out-alt mr-2"></i>Sign out
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content flex-1 min-w-0">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 bg-[#0d1117]/80 backdrop-blur border-b border-[#2d3748]">
      <div class="px-4 py-3 flex items-center gap-3">
        <button id="menuToggle" class="lg:hidden">
          <i class="fas fa-bars"></i>
        </button>
        
        <div class="flex-1 relative">
          <div id="searchContainer" class="absolute inset-0 flex items-center opacity-0 pointer-events-none transition-opacity">
            <input id="searchInput" type="text" placeholder="Search by name…" class="w-full bg-[#0f1520] border border-[#2d3748] rounded-xl px-4 py-2 pl-10 outline-none focus:ring-2 focus:ring-emerald-500 placeholder-gray-500" />
            <i class="fas fa-search absolute left-3 text-gray-500"></i>
          </div>
        </div>

        <button id="searchToggle" class="btn p-2 rounded-lg hover:bg-[#161b22]">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </header>

    <!-- Users List -->
    <main class="p-4">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-base font-semibold">All Users</h2>
          <div class="flex items-center gap-2 text-sm text-gray-400">
            <span id="countLabel">0</span>
            <div id="loadingUsers" class="loader hidden"></div>
          </div>
        </div>

        <div id="usersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>

        <div class="mt-4 flex items-center justify-between">
          <button id="prevPage" class="btn pill px-3 py-2 rounded-xl disabled:opacity-50" disabled>Prev</button>
          <div id="pageInfo" class="text-sm text-gray-400"></div>
          <button id="nextPage" class="btn pill px-3 py-2 rounded-xl disabled:opacity-50" disabled>Next</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Full Screen Call Modal -->
  <div id="callModal" class="call-modal-fullscreen hidden">
    <div class="video-container">
      <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
      <video id="localVideo" autoplay playsinline muted class="local-video"></video>
      
      <div class="call-controls">
        <button id="toggleVideo" class="control-btn active">
          <i class="fas fa-video"></i>
        </button>
        <button id="toggleAudio" class="control-btn active">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="endCall" class="control-btn end-call">
          <i class="fas fa-phone"></i>
        </button>
        <button id="toggleFullscreen" class="control-btn">
          <i class="fas fa-expand"></i>
        </button>
      </div>
      
      <div class="absolute top-4 left-4 bg-black/60 text-white px-3 py-2 rounded-lg">
        <span id="callTimer">00:00</span>
      </div>
      
      <div class="absolute top-4 right-4 bg-black/60 text-white px-3 py-2 rounded-lg">
        <span id="callStatus">Connecting...</span>
      </div>
      
      <button id="minimizeCall" class="absolute top-4 right-4 bg-black/60 text-white w-10 h-10 rounded-full flex items-center justify-center">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- Incoming Call Toast -->
  <div id="incomingToast" class="fixed bottom-4 right-4 hidden card p-4 max-w-sm z-50">
    <div class="flex items-center gap-3">
      <img id="toastAvatar" class="w-12 h-12 rounded-full object-cover border border-[#2d3748]" src="https://www.svgrepo.com/show/452030/avatar-default.svg"/>
      <div class="flex-1">
        <div class="font-semibold" id="toastTitle">Incoming call</div>
        <div class="text-sm text-gray-400" id="toastMsg"></div>
      </div>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <button id="acceptCall" class="btn btn-primary px-3 py-2 rounded-xl flex items-center gap-2">
        <i class="fas fa-phone"></i> Accept
      </button>
      <button id="declineCall" class="btn pill px-3 py-2 rounded-xl flex items-center gap-2">
        <i class="fas fa-times"></i> Decline
      </button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, startAfter, getDocs, doc, getDoc, updateDoc, setDoc, addDoc, serverTimestamp, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAwB8JWKIRK6Bkat-NdM6OyVAvdrBk5cmM",
      authDomain: "capturedeep-126bf.firebaseapp.com",
      databaseURL: "https://capturedeep-126bf-default-rtdb.firebaseio.com",
      projectId: "capturedeep-126bf",
      storageBucket: "capturedeep-126bf.appspot.com",
      messagingSenderId: "527347157327",
      appId: "1:527347157327:web:d7db7bb6d0fe021547dd3a",
      measurementId: "G-VZEFR8X5BN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State ---
    let PAGE_SIZE = 12; // users per page
    let lastVisible = null; // for pagination
    let currentPage = 1;
    let me = null; // current user profile
    let unsubscribeIncoming = null;
    let callTimerInterval = null;
    let callStartTime = null;

    // Presence heartbeat config
    const HEARTBEAT_MS = 20000; // update every 20s
    const ONLINE_WINDOW_MS = 30000; // considered online if lastActive within 30s

    const usersCol = collection(db, 'users');

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const ageFromDOB = (dobStr) => {
      if (!dobStr) return null;
      const dob = new Date(dobStr);
      const now = new Date();
      let a = now.getFullYear() - dob.getFullYear();
      const m = now.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) a--;
      return a;
    }
    const isOnlineFromLastActive = (ts) => {
      if (!ts) return false;
      const last = ts.toDate ? ts.toDate().getTime() : new Date(ts).getTime();
      return Date.now() - last < ONLINE_WINDOW_MS;
    }
    const debounce = (fn, ms) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      }
    }
    const formatTime = (seconds) => {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // --- UI Controls ---
    $('menuToggle').addEventListener('click', () => {
      $('sidebar').classList.toggle('open');
    });

    $('closeSidebar').addEventListener('click', () => {
      $('sidebar').classList.remove('open');
    });

    $('searchToggle').addEventListener('click', () => {
      const searchContainer = $('searchContainer');
      if (searchContainer.classList.contains('opacity-0')) {
        searchContainer.classList.remove('opacity-0', 'pointer-events-none');
        $('searchInput').focus();
      } else {
        searchContainer.classList.add('opacity-0', 'pointer-events-none');
      }
    });

    // --- Auth Guard & bootstrap ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not logged in – go back to auth page
        window.location.href = 'index.html';
        return;
      }
      // load my profile
      const snap = await getDoc(doc(db, 'users', user.uid));
      me = snap.exists() ? snap.data() : { uid: user.uid, name: user.email, email: user.email };
      // Update UI header
      $('meName').textContent = me.name || me.email || 'Me';
      $('meEmail').textContent = me.email || '';
      $('meAvatar').src = me.photoURL || 'https://www.svgrepo.com/show/452030/avatar-default.svg';
      $('authUser').classList.remove('hidden');

      // heartbeat presence
      await updateDoc(doc(db, 'users', user.uid), { lastActive: serverTimestamp() }).catch(async () => {
        // if doc may not exist, create minimal
        await setDoc(doc(db, 'users', user.uid), { uid: user.uid, name: me.name || '', email: user.email, lastActive: serverTimestamp() }, { merge: true });
      });
      setInterval(() => {
        updateDoc(doc(db, 'users', user.uid), { lastActive: serverTimestamp() }).catch(() => { });
      }, HEARTBEAT_MS);

      // live incoming calls
      listenIncomingCalls();

      // first load
      loadUsers(true);
    });

    $('signOutBtn').addEventListener('click', async () => {
      await signOut(auth);
    });

    // --- Users list, filters & pagination ---
    const state = { gender: '', presence: '', q: '', minAge: 13, maxAge: 120, cache: [], page: 1 };

    $('resetFilters').onclick = () => {
      $('searchInput').value = '';
      $('genderFilter').value = '';
      $('presenceFilter').value = '';
      $('minAge').value = 13;
      $('maxAge').value = 120;
      state.gender = '';
      state.presence = '';
      state.q = '';
      state.minAge = 13;
      state.maxAge = 120;
      currentPage = 1;
      lastVisible = null;
      loadUsers(true);
    }
    $('genderFilter').onchange = (e) => { state.gender = e.target.value; currentPage = 1; lastVisible = null; loadUsers(true); }
    $('presenceFilter').onchange = (e) => { state.presence = e.target.value; renderUsers(state.cache); }
    $('minAge').onchange = (e) => { state.minAge = +e.target.value || 13; renderUsers(state.cache); }
    $('maxAge').onchange = (e) => { state.maxAge = +e.target.value || 120; renderUsers(state.cache); }
    $('searchInput').addEventListener('input', debounce((e) => { state.q = e.target.value.toLowerCase(); renderUsers(state.cache); }, 300));

    $('prevPage').onclick = () => { if (currentPage > 1) { currentPage--; lastVisible = pageStack[currentPage - 1]?.cursor || null; loadUsers(false, true); } }
    $('nextPage').onclick = () => { if (canNext) { currentPage++; loadUsers(); } }

    let pageStack = [{ cursor: null }];
    let canNext = false;

    async function loadUsers(reset = false, backwards = false) {
      $('loadingUsers').classList.remove('hidden');
      const base = [orderBy('createdAt', 'desc')];
      if (state.gender) { base.unshift(where('gender', '==', state.gender)); }

      let qy;
      if (backwards) {
        // naive backwards: reload from start up to page-1
        lastVisible = null; pageStack = [{ cursor: null }];
        const targetPage = currentPage; currentPage = 1;
        let docsAcc = [];
        while (currentPage <= targetPage) {
          qy = query(usersCol, ...base, limit(PAGE_SIZE));
          if (lastVisible) qy = query(usersCol, ...base, startAfter(lastVisible), limit(PAGE_SIZE));
          const snap = await getDocs(qy);
          docsAcc = snap.docs; // last batch only (we cache below)
          lastVisible = snap.docs[snap.docs.length - 1] || null;
          pageStack[currentPage] = { cursor: lastVisible };
          currentPage++;
        }
        currentPage = targetPage;
        state.cache = docsAcc.map(d => ({ id: d.id, ...d.data() }));
        canNext = docsAcc.length === PAGE_SIZE;
      } else {
        qy = query(usersCol, ...base, limit(PAGE_SIZE));
        if (lastVisible) qy = query(usersCol, ...base, startAfter(lastVisible), limit(PAGE_SIZE));
        const snap = await getDocs(qy);
        state.cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        lastVisible = snap.docs[snap.docs.length - 1] || null;
        pageStack[currentPage] = { cursor: lastVisible };
        canNext = snap.size === PAGE_SIZE;
      }
      renderUsers(state.cache);
      $('pageInfo').textContent = `Page ${currentPage}`;
      $('prevPage').disabled = currentPage <= 1;
      $('nextPage').disabled = !canNext;
      $('loadingUsers').classList.add('hidden');
    }

    function renderUsers(list) {
      const grid = $('usersGrid');
      grid.innerHTML = '';
      // filters (client-side)
      const filtered = list.filter(u => {
        if (!u.uid || (me && u.uid === me.uid)) return false; // hide myself
        // presence
        const online = isOnlineFromLastActive(u.lastActive);
        if (state.presence === 'online' && !online) return false;
        if (state.presence === 'offline' && online) return false;
        // age
        const age = ageFromDOB(u.dob);
        if (age !== null && (age < state.minAge || age > state.maxAge)) return false;
        // search
        if (state.q) {
          const blob = `${(u.name || '').toLowerCase()} ${(u.email || '').toLowerCase()}`;
          if (!blob.includes(state.q)) return false;
        }
        return true;
      });

      $('countLabel').textContent = `${filtered.length} users in view`;

      filtered.forEach(u => {
        const online = isOnlineFromLastActive(u.lastActive);
        const age = ageFromDOB(u.dob);
        const card = document.createElement('div');
        card.className = 'p-3 rounded-xl border border-[#2d3748] bg-[#0f1520] flex gap-3 items-center';
        card.innerHTML = `
          <img src="${u.photoURL || 'https://www.svgrepo.com/show/452030/avatar-default.svg'}" class="w-14 h-14 rounded-full object-cover border border-[#2d3748]"/>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <div class="online-dot ${online ? 'bg-emerald-500' : 'bg-gray-500'}"></div>
              <div class="font-semibold truncate">${u.name || 'Unknown'}</div>
            </div>
            <div class="text-sm text-gray-400 truncate">${u.gender ? u.gender[0].toUpperCase() + u.gender.slice(1) : '—'} • ${age !== null ? age + ' yrs' : 'Age N/A'}</div>
          </div>
          <button class="btn btn-primary px-3 py-2 rounded-xl flex items-center gap-2" data-uid="${u.uid}" data-name="${u.name || ''}" data-photo="${u.photoURL || ''}">
            <i class="fas fa-phone"></i> Call
          </button>
        `;
        grid.appendChild(card);
      });

      // attach call handlers
      [...grid.querySelectorAll('button[data-uid]')].forEach(btn => {
        btn.onclick = () => startOutgoingCall({ uid: btn.dataset.uid, name: btn.dataset.name, photoURL: btn.dataset.photo });
      })

      // update my online dot
      $('meOnlineDot').classList.toggle('bg-emerald-500', true);
    }

    // --- WebRTC Signaling (Firestore) ---
    // Collections layout:
    // calls/{callId}: { status, createdAt, callerUid, calleeUid, offer, answer }
    // calls/{callId}/callerCandidates/* ICE
    // calls/{callId}/calleeCandidates/* ICE

    let pc = null; let localStream = null; let remoteStream = null; let currentCallId = null; let callUnsubs = [];
    const rtcCfg = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    function cleanupCallListeners() { callUnsubs.forEach(u => u && u()); callUnsubs = []; }
    function resetPeer() {
      if (pc) { pc.onicecandidate = null; pc.ontrack = null; pc.close(); pc = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (remoteStream) { remoteStream.getTracks().forEach(t => t.stop()); remoteStream = null; }
      currentCallId = null;
      cleanupCallListeners();
      $('callModal').classList.add('hidden');
      clearInterval(callTimerInterval);
      callTimerInterval = null;
      callStartTime = null;
    }

    async function ensureMedia() {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        $('localVideo').srcObject = localStream;
      } catch (err) {
        console.error("Error accessing media devices:", err);
        alert("Could not access your camera/microphone. Please check permissions.");
        throw err;
      }
    }

    function startCallTimer() {
      callStartTime = Date.now();
      clearInterval(callTimerInterval);
      callTimerInterval = setInterval(() => {
        const elapsedSeconds = Math.floor((Date.now() - callStartTime) / 1000);
        $('callTimer').textContent = formatTime(elapsedSeconds);
      }, 1000);
    }

    async function startOutgoingCall(target) {
      try {
        await ensureMedia();
        $('callStatus').textContent = 'Creating offer';
        $('callModal').classList.remove('hidden');

        // quick notify if looks offline
        const calleeSnap = await getDoc(doc(db, 'users', target.uid));
        const callee = calleeSnap.data();
        const offline = !isOnlineFromLastActive(callee?.lastActive);

        pc = new RTCPeerConnection(rtcCfg);
        remoteStream = new MediaStream();
        $('remoteVideo').srcObject = remoteStream;
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = (e) => {
          console.log("Received remote track");
          e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
        }

        const callDocRef = await addDoc(collection(db, 'calls'), {
          status: 'ringing',
          createdAt: serverTimestamp(),
          callerUid: me.uid,
          callerName: me.name || me.email || 'Caller',
          calleeUid: target.uid,
        });
        currentCallId = callDocRef.id;

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await updateDoc(callDocRef, { offer });
        $('callStatus').textContent = offline ? 'User may be offline. Waiting for answer…' : 'Ringing…';

        // ICE candidates (caller side)
        const callerCandCol = collection(db, 'calls', currentCallId, 'callerCandidates');
        pc.onicecandidate = (e) => { if (e.candidate) { addDoc(callerCandCol, e.candidate.toJSON()); } };

        // watch for answer
        callUnsubs.push(onSnapshot(callDocRef, async (snap) => {
          const data = snap.data();
          if (!pc || !data) return;
          if (data.status === 'declined') { $('callStatus').textContent = 'Call declined'; }
          if (data.answer && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            $('callStatus').textContent = 'Connected';
            startCallTimer();
          }
          if (data.status === 'ended') endCall();
        }));

        // callee ICE
        callUnsubs.push(onSnapshot(collection(db, 'calls', currentCallId, 'calleeCandidates'), (qs) => {
          qs.docChanges().forEach(async ch => { if (ch.type === 'added') { try { await pc.addIceCandidate(ch.doc.data()); } catch (e) { } } })
        }));

        // if offline – drop a notification doc for the user
        if (offline) {
          await addDoc(collection(db, 'notifications'), { toUid: target.uid, type: 'missed_or_pending', fromUid: me.uid, fromName: me.name || '', createdAt: serverTimestamp(), message: 'Tried to call you.' });
        }
      } catch (err) {
        console.error("Error starting outgoing call:", err);
        alert("Failed to start call. Please try again.");
        resetPeer();
      }
    }

    async function endCall() {
      if (currentCallId) {
        await updateDoc(doc(db, 'calls', currentCallId), { status: 'ended' }).catch(() => { });
      }
      resetPeer();
    }

    $('endCall').onclick = endCall;
    $('minimizeCall').onclick = () => {
      // For now, just end call when minimized. In a real app, you'd implement picture-in-picture or minimize to a small window
      endCall();
    };

    $('toggleAudio').addEventListener('click', function() {
      if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length > 0) {
          const enabled = !audioTracks[0].enabled;
          audioTracks[0].enabled = enabled;
          this.classList.toggle('active', enabled);
          this.innerHTML = enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        }
      }
    });

    $('toggleVideo').addEventListener('click', function() {
      if (localStream) {
        const videoTracks = localStream.getVideoTracks();
        if (videoTracks.length > 0) {
          const enabled = !videoTracks[0].enabled;
          videoTracks[0].enabled = enabled;
          this.classList.toggle('active', enabled);
          this.innerHTML = enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
          $('localVideo').style.opacity = enabled ? '1' : '0.5';
        }
      }
    });

    $('toggleFullscreen').addEventListener('click', function() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error('Error attempting to enable fullscreen:', err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // Incoming calls listener
    function listenIncomingCalls() {
      if (unsubscribeIncoming) unsubscribeIncoming();
      const qy = query(collection(db, 'calls'), where('calleeUid', '==', auth.currentUser.uid), where('status', '==', 'ringing'));
      unsubscribeIncoming = onSnapshot(qy, (qs) => {
        qs.docChanges().forEach(ch => {
          if (ch.type === 'added') {
            const id = ch.doc.id;
            const data = ch.doc.data();
            showIncomingToast(id, data);
          }
        })
      })
    }

    function showIncomingToast(callId, data) {
      $('toastAvatar').src = data.callerPhotoURL || 'https://www.svgrepo.com/show/452030/avatar-default.svg';
      $('toastTitle').textContent = 'Incoming call';
      $('toastMsg').textContent = `from ${data.callerName || 'Unknown'}`;
      $('incomingToast').classList.remove('hidden');

      $('acceptCall').onclick = () => acceptIncoming(callId, data);
      $('declineCall').onclick = () => declineIncoming(callId);
    }

    async function acceptIncoming(callId, data) {
      $('incomingToast').classList.add('hidden');
      try {
        await ensureMedia();
        $('callModal').classList.remove('hidden');
        $('callStatus').textContent = 'Connecting…';

        pc = new RTCPeerConnection(rtcCfg);
        remoteStream = new MediaStream();
        $('remoteVideo').srcObject = remoteStream;
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = (e) => {
          console.log("Received remote track");
          e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
        }

        const callRef = doc(db, 'calls', callId);
        const callSnap = await getDoc(callRef);
        const callData = callSnap.data();
        currentCallId = callId;

        await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(callRef, { answer, status: 'connected' });

        // ICE (callee side)
        const calleeCandCol = collection(db, 'calls', callId, 'calleeCandidates');
        pc.onicecandidate = (e) => { if (e.candidate) { addDoc(calleeCandCol, e.candidate.toJSON()); } };

        // caller ICE
        callUnsubs.push(onSnapshot(collection(db, 'calls', callId, 'callerCandidates'), (qs) => {
          qs.docChanges().forEach(async ch => { if (ch.type === 'added') { try { await pc.addIceCandidate(ch.doc.data()); } catch (e) { } } });
        }));

        // end watcher
        callUnsubs.push(onSnapshot(callRef, (snap) => { const d = snap.data(); if (d?.status === 'ended') { endCall(); } }));

        startCallTimer();
      } catch (err) {
        console.error("Error accepting incoming call:", err);
        alert("Failed to accept call. Please try again.");
        resetPeer();
      }
    }

    async function declineIncoming(callId) {
      $('incomingToast').classList.add('hidden');
      await updateDoc(doc(db, 'calls', callId), { status: 'declined' }).catch(() => { });
    }

    // page visibility: quick lastActive update
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && auth.currentUser) {
        updateDoc(doc(db, 'users', auth.currentUser.uid), { lastActive: serverTimestamp() }).catch(() => { });
      }
    });

  </script>
</body>
</html>
